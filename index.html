<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashFlow | Mrs Kim's Grill</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --bg: #0a0a0b;
            --bg-card: #111113;
            --bg-hover: #1a1a1d;
            --border: #222228;
            --text: #ffffff;
            --text-secondary: #888894;
            --text-muted: #555560;
            --green: #22c55e;
            --green-bg: rgba(34, 197, 94, 0.1);
            --red: #ef4444;
            --red-bg: rgba(239, 68, 68, 0.1);
            --orange: #f97316;
            --orange-bg: rgba(249, 115, 22, 0.1);
            --blue: #3b82f6;
            --blue-bg: rgba(59, 130, 246, 0.1);
            --yellow: #eab308;
            --yellow-bg: rgba(234, 179, 8, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Layout */
        .app { display: flex; min-height: 100vh; }

        .sidebar {
            width: 240px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 20px 12px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .main {
            flex: 1;
            margin-left: 240px;
            padding: 24px;
            max-width: 1200px;
        }

        /* Mobile */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            align-items: center;
            padding: 0 16px;
            z-index: 101;
        }

        .menu-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-hover);
            border: none;
            border-radius: 8px;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
        }

        .overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 99;
        }

        /* Sidebar Content */
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin-bottom: 24px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--green), #16a34a);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .logo-text { font-size: 18px; font-weight: 700; }
        .logo-text span { color: var(--green); }

        .nav-section { margin-bottom: 20px; }
        .nav-label { font-size: 10px; font-weight: 600; color: var(--text-muted); padding: 0 12px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s;
            margin-bottom: 2px;
        }

        .nav-item:hover { background: var(--bg-hover); color: var(--text); }
        .nav-item.active { background: var(--green-bg); color: var(--green); }
        .nav-item svg { width: 18px; height: 18px; }

        .nav-badge {
            margin-left: auto;
            background: var(--red);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .nav-badge.warning { background: var(--orange); }

        .nav-divider { height: 1px; background: var(--border); margin: 16px 0; }

        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title { font-size: 24px; font-weight: 700; }
        .page-subtitle { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
            font-family: inherit;
        }

        .btn-primary { background: var(--green); color: white; }
        .btn-primary:hover { background: #16a34a; }
        .btn-secondary { background: var(--bg-hover); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--red-bg); color: var(--red); }
        .btn-danger:hover { background: var(--red); color: white; }
        .btn-success { background: var(--green-bg); color: var(--green); }
        .btn-success:hover { background: var(--green); color: white; }
        .btn-small { padding: 6px 10px; font-size: 12px; }
        .btn svg { width: 16px; height: 16px; }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.02));
            border-color: rgba(34, 197, 94, 0.3);
        }

        .stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 700; }
        .stat-value.green { color: var(--green); }
        .stat-value.red { color: var(--red); }
        .stat-value.orange { color: var(--orange); }
        .stat-sub { font-size: 11px; color: var(--text-muted); margin-top: 6px; }

        /* Period Filter */
        .period-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            transition: all 0.15s;
        }

        .period-btn:hover { background: var(--bg-hover); color: var(--text); }
        .period-btn.active { background: var(--green); border-color: var(--green); color: white; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .card-title { font-size: 15px; font-weight: 600; }
        .card-body { padding: 16px 20px; }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 24px;
        }

        /* Upcoming Payments */
        .upcoming-section { margin-bottom: 24px; }
        .section-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .section-title .count { background: var(--orange); color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; }

        .upcoming-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-hover);
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--orange);
        }

        .upcoming-item.overdue { border-left-color: var(--red); background: var(--red-bg); }
        .upcoming-item.due-soon { border-left-color: var(--yellow); background: var(--yellow-bg); }

        .upcoming-info { flex: 1; min-width: 0; }
        .upcoming-name { font-weight: 500; font-size: 14px; margin-bottom: 2px; }
        .upcoming-meta { font-size: 12px; color: var(--text-secondary); }

        .upcoming-amount { font-weight: 700; font-size: 15px; color: var(--red); margin-right: 12px; }

        .upcoming-due {
            text-align: right;
            font-size: 11px;
            color: var(--text-muted);
        }

        .upcoming-due.overdue { color: var(--red); font-weight: 600; }
        .upcoming-due.due-soon { color: var(--yellow); font-weight: 600; }

        /* Transaction List */
        .tx-list { max-height: 400px; overflow-y: auto; }

        .tx-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
            margin-bottom: 4px;
        }

        .tx-item:hover { background: var(--bg-hover); }

        .tx-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .tx-icon.income { background: var(--green-bg); }
        .tx-icon.expense { background: var(--red-bg); }
        .tx-icon.pending { background: var(--orange-bg); }

        .tx-info { flex: 1; min-width: 0; }
        .tx-name { font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tx-meta { font-size: 12px; color: var(--text-muted); display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

        .tx-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .tx-badge.pending { background: var(--orange-bg); color: var(--orange); }
        .tx-badge.paid { background: var(--green-bg); color: var(--green); }
        .tx-badge.overdue { background: var(--red-bg); color: var(--red); }

        .tx-amount { font-weight: 600; font-size: 14px; text-align: right; }
        .tx-amount.income { color: var(--green); }
        .tx-amount.expense { color: var(--red); }

        .tx-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .tx-item:hover .tx-actions { opacity: 1; }

        .tx-action {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tx-action:hover { background: var(--green); border-color: var(--green); color: white; }
        .tx-action.delete:hover { background: var(--red); border-color: var(--red); }
        .tx-action svg { width: 14px; height: 14px; }

        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state h3 { font-size: 14px; margin-bottom: 4px; color: var(--text-secondary); }

        /* Quick Add Buttons */
        .quick-add {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .quick-btn {
            flex: 1;
            padding: 16px;
            border-radius: 10px;
            border: 1px dashed var(--border);
            background: transparent;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
            color: var(--text-secondary);
        }

        .quick-btn:hover { background: var(--bg-hover); border-style: solid; color: var(--text); }
        .quick-btn .icon { font-size: 24px; margin-bottom: 6px; }
        .quick-btn .label { font-size: 12px; font-weight: 500; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            padding: 20px;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 440px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { width: 32px; height: 32px; border-radius: 8px; background: var(--bg-hover); border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; }
        .modal-close:hover { background: var(--red); color: white; }

        /* Form */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--green); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-hint { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; }
        .form-actions .btn { flex: 1; }

        /* Type Toggle */
        .type-toggle {
            display: flex;
            background: var(--bg);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 16px;
        }

        .type-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--text-muted);
        }

        .type-btn.active.income { background: var(--green); color: white; }
        .type-btn.active.expense { background: var(--red); color: white; }
        .type-btn.active.bill { background: var(--orange); color: white; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 20px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
            font-size: 13px;
        }

        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 3px solid var(--green); }
        .toast.error { border-left: 3px solid var(--red); }

        /* Settings */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .setting-item:last-child { border-bottom: none; }
        .setting-label { font-size: 14px; font-weight: 500; }
        .setting-desc { font-size: 12px; color: var(--text-muted); }
        .setting-input { width: 200px; }

        /* Utilities */
        .hidden { display: none !important; }
        .page { display: none; }
        .page.active { display: block; }

        /* Responsive */
        @media (max-width: 1024px) {
            .content-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            .sidebar { transform: translateX(-100%); transition: transform 0.3s; }
            .sidebar.open { transform: translateX(0); }
            .overlay.open { display: block; }
            .main { margin-left: 0; padding: 72px 16px 24px; }
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
            .stat-card { padding: 16px; }
            .stat-value { font-size: 22px; }
            .page-title { font-size: 20px; }
            .form-row { grid-template-columns: 1fr; }
            .tx-actions { opacity: 1; }
            .quick-add { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="mobile-header">
        <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
        <div class="logo-text" style="margin-left: 12px;">Cash<span>Flow</span></div>
    </div>
    <div class="overlay" onclick="toggleSidebar()"></div>

    <div class="app">
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">üí∞</div>
                <div class="logo-text">Cash<span>Flow</span></div>
            </div>

            <nav class="nav-section">
                <div class="nav-label">Overview</div>
                <div class="nav-item active" data-page="dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                    Dashboard
                </div>
                <div class="nav-item" data-page="transactions">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    All Transactions
                    <span class="nav-badge warning" id="navTxCount">0</span>
                </div>
                <div class="nav-item" data-page="bills">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    Pending Bills
                    <span class="nav-badge" id="navBillCount" style="display:none;">0</span>
                </div>
            </nav>

            <div class="nav-divider"></div>

            <nav class="nav-section">
                <div class="nav-label">Quick Add</div>
                <div class="nav-item" onclick="openModal('income')" style="color: var(--green);">
                    <span>üìà</span> Add Income
                </div>
                <div class="nav-item" onclick="openModal('expense')" style="color: var(--red);">
                    <span>üìâ</span> Add Expense
                </div>
                <div class="nav-item" onclick="openModal('bill')" style="color: var(--orange);">
                    <span>üìã</span> Add Bill
                </div>
            </nav>

            <div class="nav-divider"></div>

            <nav class="nav-section" style="margin-top: auto;">
                <div class="nav-item" data-page="settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                    Settings
                </div>
            </nav>
        </aside>

        <main class="main">
            <!-- Dashboard -->
            <section class="page active" id="dashboardPage">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Cash Flow Dashboard</h1>
                        <p class="page-subtitle" id="currentPeriod">This Month</p>
                    </div>
                    <button class="btn btn-primary" onclick="openModal()">+ Add Transaction</button>
                </div>

                <div class="period-filter">
                    <button class="period-btn active" data-period="month">This Month</button>
                    <button class="period-btn" data-period="lastmonth">Last Month</button>
                    <button class="period-btn" data-period="year">This Year</button>
                    <button class="period-btn" data-period="all">All Time</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card highlight">
                        <div class="stat-label">üí∞ Current Balance</div>
                        <div class="stat-value green" id="currentBalance">$0.00</div>
                        <div class="stat-sub" id="balanceDesc">Starting + Income - Expenses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üìà Money In</div>
                        <div class="stat-value green" id="totalIn">$0.00</div>
                        <div class="stat-sub" id="inCount">0 transactions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üìâ Money Out</div>
                        <div class="stat-value red" id="totalOut">$0.00</div>
                        <div class="stat-sub" id="outCount">0 transactions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">‚è≥ Upcoming Bills</div>
                        <div class="stat-value orange" id="upcomingTotal">$0.00</div>
                        <div class="stat-sub" id="upcomingCount">0 pending</div>
                    </div>
                </div>

                <!-- Upcoming Payments Alert -->
                <div class="upcoming-section" id="upcomingSection">
                    <div class="section-title">
                        ‚ö†Ô∏è Upcoming Payments
                        <span class="count" id="upcomingBadge">0</span>
                    </div>
                    <div id="upcomingList"></div>
                </div>

                <div class="content-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Transactions</h3>
                            <div style="display: flex; gap: 6px;">
                                <button class="btn btn-small btn-secondary filter-btn active" data-filter="all">All</button>
                                <button class="btn btn-small btn-secondary filter-btn" data-filter="income">In</button>
                                <button class="btn btn-small btn-secondary filter-btn" data-filter="expense">Out</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="tx-list" id="recentTxList"></div>
                        </div>
                    </div>

                    <div>
                        <div class="quick-add">
                            <button class="quick-btn" onclick="openModal('income')">
                                <div class="icon">üíµ</div>
                                <div class="label">Add Income</div>
                            </button>
                            <button class="quick-btn" onclick="openModal('expense')">
                                <div class="icon">üí∏</div>
                                <div class="label">Add Expense</div>
                            </button>
                            <button class="quick-btn" onclick="openModal('bill')">
                                <div class="icon">üìã</div>
                                <div class="label">Add Bill</div>
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Cash Flow Summary</h3>
                            </div>
                            <div class="card-body" id="summaryContent">
                                <!-- Summary will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- All Transactions -->
            <section class="page" id="transactionsPage">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">All Transactions</h1>
                        <p class="page-subtitle">Complete history</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="exportData()">Export</button>
                        <button class="btn btn-primary" onclick="openModal()">+ Add</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            <button class="btn btn-small btn-secondary all-filter-btn active" data-filter="all">All</button>
                            <button class="btn btn-small btn-secondary all-filter-btn" data-filter="income">Income</button>
                            <button class="btn btn-small btn-secondary all-filter-btn" data-filter="expense">Expense</button>
                            <button class="btn btn-small btn-secondary all-filter-btn" data-filter="pending">Pending</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="tx-list" id="allTxList" style="max-height: none;"></div>
                    </div>
                </div>
            </section>

            <!-- Pending Bills -->
            <section class="page" id="billsPage">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Pending Bills</h1>
                        <p class="page-subtitle">Bills & invoices to pay</p>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('bill')">+ Add Bill</button>
                </div>

                <div id="overdueAlert" class="card hidden" style="border-left: 3px solid var(--red); margin-bottom: 20px;">
                    <div class="card-body" style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 28px;">üö®</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--red);" id="overdueTitle">Overdue Bills!</div>
                            <div style="font-size: 13px; color: var(--text-secondary);" id="overdueDesc">You have overdue payments</div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--red);" id="overdueAmount">$0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div id="billsList"></div>
                    </div>
                </div>
            </section>

            <!-- Settings -->
            <section class="page" id="settingsPage">
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                </div>

                <div class="card" style="max-width: 500px;">
                    <div class="card-body">
                        <div class="setting-item">
                            <div>
                                <div class="setting-label">Starting Balance</div>
                                <div class="setting-desc">Your initial cash balance</div>
                            </div>
                            <input type="number" class="form-input setting-input" id="startingBalance" step="0.01" onchange="saveSettings()">
                        </div>
                        <div class="setting-item">
                            <div>
                                <div class="setting-label">Business Name</div>
                                <div class="setting-desc">Your business name</div>
                            </div>
                            <input type="text" class="form-input setting-input" id="businessName" onchange="saveSettings()">
                        </div>
                        <div class="setting-item">
                            <div>
                                <div class="setting-label">Currency</div>
                                <div class="setting-desc">Display currency</div>
                            </div>
                            <select class="form-select setting-input" id="currency" onchange="saveSettings()">
                                <option value="AUD">AUD ($)</option>
                                <option value="USD">USD ($)</option>
                                <option value="KRW">KRW (‚Ç©)</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div>
                                <div class="setting-label">Data Management</div>
                                <div class="setting-desc">Export or import data</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-small btn-secondary" onclick="exportData()">Export</button>
                                <button class="btn btn-small btn-secondary" onclick="importData()">Import</button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div>
                                <div class="setting-label" style="color: var(--red);">Delete All Data</div>
                                <div class="setting-desc">This cannot be undone</div>
                            </div>
                            <button class="btn btn-small btn-danger" onclick="clearAll()">Delete</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal-overlay" id="txModal" onclick="if(event.target===this)closeModal()">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add Transaction</h3>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>

            <div class="type-toggle">
                <button type="button" class="type-btn income" onclick="setType('income')">üíµ Income</button>
                <button type="button" class="type-btn expense active" onclick="setType('expense')">üí∏ Expense</button>
                <button type="button" class="type-btn bill" onclick="setType('bill')">üìã Bill</button>
            </div>

            <form id="txForm">
                <input type="hidden" id="txId">
                <input type="hidden" id="txType" value="expense">

                <div class="form-group">
                    <label class="form-label">Description *</label>
                    <input type="text" class="form-input" id="txDesc" placeholder="What is this for?" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Amount *</label>
                        <input type="number" class="form-input" id="txAmount" step="0.01" min="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="txCategory">
                            <option value="general">General</option>
                            <option value="sales">Sales/Revenue</option>
                            <option value="supplies">Supplies</option>
                            <option value="utilities">Utilities</option>
                            <option value="rent">Rent</option>
                            <option value="payroll">Payroll</option>
                            <option value="food">Food/Ingredients</option>
                            <option value="transport">Transport</option>
                            <option value="marketing">Marketing</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date *</label>
                        <input type="date" class="form-input" id="txDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Scope</label>
                        <select class="form-select" id="txScope">
                            <option value="business">Business</option>
                            <option value="personal">Personal</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="dueDateGroup" style="display: none;">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="txDueDate">
                    <div class="form-hint">When does this need to be paid?</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <input type="text" class="form-input" id="txNotes" placeholder="Optional notes...">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-danger" id="deleteBtn" onclick="deleteTx()" style="display: none;">Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ========== STATE ==========
        let transactions = [];
        let settings = {
            startingBalance: 0,
            businessName: "Mrs Kim's Grill",
            currency: 'AUD'
        };
        let currentPeriod = 'month';
        let currentFilter = 'all';
        let allFilter = 'all';
        let editingId = null;

        const currencySymbols = { AUD: '$', USD: '$', KRW: '‚Ç©' };

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCJImX9qW95kBuScldawlk0OfYv8Qe7hzI",
            authDomain: "finance-tool-for-hugh.firebaseapp.com",
            projectId: "finance-tool-for-hugh"
        };

        let db = null;

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            loadData();
            setupEventListeners();
        });

        function initFirebase() {
            try {
                if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
                db = firebase.firestore();
            } catch (e) {
                console.error('Firebase error:', e);
            }
        }

        async function loadData() {
            // Load from localStorage
            const savedTx = localStorage.getItem('cf_transactions');
            const savedSettings = localStorage.getItem('cf_settings');
            if (savedTx) transactions = JSON.parse(savedTx);
            if (savedSettings) settings = { ...settings, ...JSON.parse(savedSettings) };

            // Try Firebase
            if (db) {
                try {
                    const snap = await db.collection('users').doc('hugh').collection('cashflow').orderBy('createdAt', 'desc').get();
                    if (!snap.empty) {
                        transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        saveLocal();
                    }
                } catch (e) {}
            }

            // Update UI
            document.getElementById('startingBalance').value = settings.startingBalance || 0;
            document.getElementById('businessName').value = settings.businessName;
            document.getElementById('currency').value = settings.currency;
            updateUI();
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    showPage(item.dataset.page);
                    document.querySelector('.sidebar').classList.remove('open');
                    document.querySelector('.overlay').classList.remove('open');
                });
            });

            // Period filter
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentPeriod = btn.dataset.period;
                    updateUI();
                });
            });

            // Dashboard filter
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderRecentTx();
                });
            });

            // All transactions filter
            document.querySelectorAll('.all-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.all-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    allFilter = btn.dataset.filter;
                    renderAllTx();
                });
            });

            // Form
            document.getElementById('txForm').addEventListener('submit', e => {
                e.preventDefault();
                saveTx();
            });
        }

        function showPage(page) {
            document.querySelectorAll('.nav-item[data-page]').forEach(i => i.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page + 'Page')?.classList.add('active');
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.overlay').classList.toggle('open');
        }

        // ========== MODAL ==========
        function openModal(type = 'expense') {
            editingId = null;
            document.getElementById('txForm').reset();
            document.getElementById('txId').value = '';
            document.getElementById('modalTitle').textContent = 'Add Transaction';
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('txDate').value = new Date().toISOString().split('T')[0];
            setType(type);
            document.getElementById('txModal').classList.add('active');
        }

        function openEditModal(id) {
            const tx = transactions.find(t => t.id === id);
            if (!tx) return;
            
            editingId = id;
            document.getElementById('txId').value = id;
            document.getElementById('modalTitle').textContent = 'Edit Transaction';
            document.getElementById('deleteBtn').style.display = 'block';
            
            const type = tx.status === 'pending' ? 'bill' : tx.type;
            setType(type);
            
            document.getElementById('txDesc').value = tx.description || '';
            document.getElementById('txAmount').value = tx.amount || 0;
            document.getElementById('txCategory').value = tx.category || 'general';
            document.getElementById('txDate').value = tx.date || '';
            document.getElementById('txScope').value = tx.scope || 'business';
            document.getElementById('txDueDate').value = tx.dueDate || '';
            document.getElementById('txNotes').value = tx.notes || '';
            
            document.getElementById('txModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('txModal').classList.remove('active');
            editingId = null;
        }

        function setType(type) {
            document.getElementById('txType').value = type;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.type-btn.${type}`)?.classList.add('active');
            document.getElementById('dueDateGroup').style.display = type === 'bill' ? 'block' : 'none';
        }

        // ========== CRUD ==========
        async function saveTx() {
            const amount = parseFloat(document.getElementById('txAmount').value);
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }

            const type = document.getElementById('txType').value;
            const tx = {
                id: editingId || Date.now().toString() + Math.random().toString(36).substr(2, 9),
                description: document.getElementById('txDesc').value,
                amount: amount,
                type: type === 'bill' ? 'expense' : type,
                category: document.getElementById('txCategory').value,
                scope: document.getElementById('txScope').value,
                date: document.getElementById('txDate').value,
                dueDate: type === 'bill' ? document.getElementById('txDueDate').value : null,
                status: type === 'bill' ? 'pending' : 'completed',
                notes: document.getElementById('txNotes').value,
                createdAt: editingId ? (transactions.find(t => t.id === editingId)?.createdAt || new Date().toISOString()) : new Date().toISOString()
            };

            if (editingId) {
                const idx = transactions.findIndex(t => t.id === editingId);
                if (idx !== -1) transactions[idx] = tx;
            } else {
                transactions.unshift(tx);
            }

            await saveData();
            closeModal();
            updateUI();
            showToast(editingId ? 'Updated!' : 'Added!', 'success');
        }

        async function deleteTx() {
            if (!editingId || !confirm('Delete this transaction?')) return;
            transactions = transactions.filter(t => t.id !== editingId);
            await saveData();
            closeModal();
            updateUI();
            showToast('Deleted', 'success');
        }

        async function quickDelete(id, e) {
            e?.stopPropagation();
            if (!confirm('Delete?')) return;
            transactions = transactions.filter(t => t.id !== id);
            await saveData();
            updateUI();
            showToast('Deleted', 'success');
        }

        async function markAsPaid(id, e) {
            e?.stopPropagation();
            const tx = transactions.find(t => t.id === id);
            if (!tx) return;
            tx.status = 'completed';
            tx.paidDate = new Date().toISOString().split('T')[0];
            await saveData();
            updateUI();
            showToast('Marked as paid!', 'success');
        }

        // ========== STORAGE ==========
        function saveLocal() {
            localStorage.setItem('cf_transactions', JSON.stringify(transactions));
        }

        async function saveData() {
            saveLocal();
            if (db) {
                try {
                    for (const tx of transactions.slice(0, 100)) {
                        await db.collection('users').doc('hugh').collection('cashflow').doc(tx.id).set(tx);
                    }
                } catch (e) {}
            }
        }

        function saveSettings() {
            settings.startingBalance = parseFloat(document.getElementById('startingBalance').value) || 0;
            settings.businessName = document.getElementById('businessName').value;
            settings.currency = document.getElementById('currency').value;
            localStorage.setItem('cf_settings', JSON.stringify(settings));
            updateUI();
            showToast('Saved', 'success');
        }

        async function clearAll() {
            if (!confirm('Delete ALL data? This cannot be undone!')) return;
            transactions = [];
            saveLocal();
            if (db) {
                try {
                    const snap = await db.collection('users').doc('hugh').collection('cashflow').get();
                    const batch = db.batch();
                    snap.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                } catch (e) {}
            }
            updateUI();
            showToast('All data deleted', 'success');
        }

        // ========== UI ==========
        function updateUI() {
            updateStats();
            updateUpcoming();
            renderRecentTx();
            renderAllTx();
            renderBills();
            renderSummary();
            updateNavBadges();
        }

        function formatCurrency(amount) {
            const sym = currencySymbols[settings.currency] || '$';
            const abs = Math.abs(amount || 0);
            if (settings.currency === 'KRW') return sym + abs.toLocaleString('ko-KR');
            return sym + abs.toLocaleString('en-AU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
        }

        function getFilteredByPeriod() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
            const startOfYear = new Date(now.getFullYear(), 0, 1);

            return transactions.filter(tx => {
                const txDate = new Date(tx.date);
                switch (currentPeriod) {
                    case 'month': return txDate >= startOfMonth;
                    case 'lastmonth': return txDate >= startOfLastMonth && txDate <= endOfLastMonth;
                    case 'year': return txDate >= startOfYear;
                    default: return true;
                }
            });
        }

        function getDaysUntilDue(dueDate) {
            if (!dueDate) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dueDate);
            due.setHours(0, 0, 0, 0);
            return Math.ceil((due - today) / (1000 * 60 * 60 * 24));
        }

        function updateStats() {
            const filtered = getFilteredByPeriod();
            const completedTx = filtered.filter(t => t.status !== 'pending');
            
            const totalIn = completedTx.filter(t => t.type === 'income').reduce((s, t) => s + (t.amount || 0), 0);
            const totalOut = completedTx.filter(t => t.type === 'expense').reduce((s, t) => s + (t.amount || 0), 0);
            
            const pending = transactions.filter(t => t.status === 'pending');
            const upcomingTotal = pending.reduce((s, t) => s + (t.amount || 0), 0);
            
            // All time for balance calculation
            const allCompleted = transactions.filter(t => t.status !== 'pending');
            const allIn = allCompleted.filter(t => t.type === 'income').reduce((s, t) => s + (t.amount || 0), 0);
            const allOut = allCompleted.filter(t => t.type === 'expense').reduce((s, t) => s + (t.amount || 0), 0);
            const balance = (settings.startingBalance || 0) + allIn - allOut;

            document.getElementById('currentBalance').textContent = formatCurrency(balance);
            document.getElementById('currentBalance').className = 'stat-value ' + (balance >= 0 ? 'green' : 'red');
            document.getElementById('balanceDesc').textContent = `After pending: ${formatCurrency(balance - upcomingTotal)}`;

            document.getElementById('totalIn').textContent = '+' + formatCurrency(totalIn);
            document.getElementById('inCount').textContent = `${completedTx.filter(t => t.type === 'income').length} transactions`;

            document.getElementById('totalOut').textContent = '-' + formatCurrency(totalOut);
            document.getElementById('outCount').textContent = `${completedTx.filter(t => t.type === 'expense').length} transactions`;

            document.getElementById('upcomingTotal').textContent = formatCurrency(upcomingTotal);
            document.getElementById('upcomingCount').textContent = `${pending.length} pending`;

            // Period label
            const periodLabels = { month: 'This Month', lastmonth: 'Last Month', year: 'This Year', all: 'All Time' };
            document.getElementById('currentPeriod').textContent = periodLabels[currentPeriod];
        }

        function updateUpcoming() {
            const pending = transactions.filter(t => t.status === 'pending').sort((a, b) => {
                if (!a.dueDate) return 1;
                if (!b.dueDate) return -1;
                return new Date(a.dueDate) - new Date(b.dueDate);
            });

            const urgent = pending.filter(t => {
                const days = getDaysUntilDue(t.dueDate);
                return days !== null && days <= 7;
            });

            const section = document.getElementById('upcomingSection');
            const list = document.getElementById('upcomingList');
            const badge = document.getElementById('upcomingBadge');

            if (urgent.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            badge.textContent = urgent.length;

            list.innerHTML = urgent.slice(0, 5).map(tx => {
                const days = getDaysUntilDue(tx.dueDate);
                let statusClass = '';
                let dueText = '';

                if (days < 0) {
                    statusClass = 'overdue';
                    dueText = `${Math.abs(days)} days overdue`;
                } else if (days === 0) {
                    statusClass = 'due-soon';
                    dueText = 'Due today!';
                } else {
                    statusClass = 'due-soon';
                    dueText = `Due in ${days} days`;
                }

                return `
                    <div class="upcoming-item ${statusClass}">
                        <div class="upcoming-info">
                            <div class="upcoming-name">${tx.description}</div>
                            <div class="upcoming-meta">${tx.category} ‚Ä¢ ${tx.scope}</div>
                        </div>
                        <div class="upcoming-amount">${formatCurrency(tx.amount)}</div>
                        <div class="upcoming-due ${statusClass}">${dueText}</div>
                        <button class="btn btn-small btn-success" onclick="markAsPaid('${tx.id}', event)">Pay</button>
                    </div>
                `;
            }).join('');
        }

        function renderTxItem(tx, showActions = true) {
            const days = getDaysUntilDue(tx.dueDate);
            let badge = '';
            let iconClass = tx.type;

            if (tx.status === 'pending') {
                iconClass = 'pending';
                if (days !== null && days < 0) {
                    badge = '<span class="tx-badge overdue">Overdue</span>';
                } else if (days !== null && days <= 7) {
                    badge = `<span class="tx-badge pending">Due ${days === 0 ? 'today' : `in ${days}d`}</span>`;
                } else {
                    badge = '<span class="tx-badge pending">Pending</span>';
                }
            }

            const payBtn = tx.status === 'pending' ? `
                <button class="tx-action" onclick="markAsPaid('${tx.id}', event)" title="Mark as paid">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                </button>
            ` : '';

            return `
                <div class="tx-item" onclick="openEditModal('${tx.id}')">
                    <div class="tx-icon ${iconClass}">${tx.type === 'income' ? 'üìà' : 'üìâ'}</div>
                    <div class="tx-info">
                        <div class="tx-name">${tx.description || 'Untitled'}</div>
                        <div class="tx-meta">
                            ${formatDate(tx.date)} ‚Ä¢ ${tx.category}
                            ${badge}
                        </div>
                    </div>
                    <div class="tx-amount ${tx.type}">${tx.type === 'income' ? '+' : '-'}${formatCurrency(tx.amount)}</div>
                    ${showActions ? `
                        <div class="tx-actions">
                            ${payBtn}
                            <button class="tx-action delete" onclick="quickDelete('${tx.id}', event)" title="Delete">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderRecentTx() {
            let filtered = getFilteredByPeriod();
            
            if (currentFilter === 'income') {
                filtered = filtered.filter(t => t.type === 'income' && t.status !== 'pending');
            } else if (currentFilter === 'expense') {
                filtered = filtered.filter(t => t.type === 'expense' && t.status !== 'pending');
            }

            const recent = filtered.slice(0, 10);
            document.getElementById('recentTxList').innerHTML = recent.length > 0
                ? recent.map(tx => renderTxItem(tx)).join('')
                : '<div class="empty-state"><h3>No transactions</h3></div>';
        }

        function renderAllTx() {
            let filtered = transactions;
            
            if (allFilter === 'income') {
                filtered = filtered.filter(t => t.type === 'income' && t.status !== 'pending');
            } else if (allFilter === 'expense') {
                filtered = filtered.filter(t => t.type === 'expense' && t.status !== 'pending');
            } else if (allFilter === 'pending') {
                filtered = filtered.filter(t => t.status === 'pending');
            }

            document.getElementById('allTxList').innerHTML = filtered.length > 0
                ? filtered.map(tx => renderTxItem(tx)).join('')
                : '<div class="empty-state"><h3>No transactions</h3></div>';
        }

        function renderBills() {
            const pending = transactions.filter(t => t.status === 'pending').sort((a, b) => {
                if (!a.dueDate) return 1;
                if (!b.dueDate) return -1;
                return new Date(a.dueDate) - new Date(b.dueDate);
            });

            const overdue = pending.filter(t => getDaysUntilDue(t.dueDate) < 0);
            const overdueAlert = document.getElementById('overdueAlert');

            if (overdue.length > 0) {
                const total = overdue.reduce((s, t) => s + (t.amount || 0), 0);
                document.getElementById('overdueTitle').textContent = `${overdue.length} Overdue Bill(s)!`;
                document.getElementById('overdueDesc').textContent = 'These payments are past their due date';
                document.getElementById('overdueAmount').textContent = formatCurrency(total);
                overdueAlert.classList.remove('hidden');
            } else {
                overdueAlert.classList.add('hidden');
            }

            document.getElementById('billsList').innerHTML = pending.length > 0
                ? pending.map(tx => {
                    const days = getDaysUntilDue(tx.dueDate);
                    let statusClass = '';
                    let dueText = tx.dueDate ? formatDate(tx.dueDate) : 'No due date';

                    if (days !== null) {
                        if (days < 0) {
                            statusClass = 'overdue';
                            dueText = `${Math.abs(days)} days overdue`;
                        } else if (days === 0) {
                            statusClass = 'due-soon';
                            dueText = 'Due today';
                        } else if (days <= 7) {
                            statusClass = 'due-soon';
                            dueText = `Due in ${days} days`;
                        }
                    }

                    return `
                        <div class="upcoming-item ${statusClass}" style="cursor: pointer;" onclick="openEditModal('${tx.id}')">
                            <div class="upcoming-info">
                                <div class="upcoming-name">${tx.description}</div>
                                <div class="upcoming-meta">${tx.category} ‚Ä¢ ${tx.scope}</div>
                            </div>
                            <div class="upcoming-amount">${formatCurrency(tx.amount)}</div>
                            <div class="upcoming-due ${statusClass}">${dueText}</div>
                            <button class="btn btn-small btn-success" onclick="markAsPaid('${tx.id}', event)">‚úì Pay</button>
                        </div>
                    `;
                }).join('')
                : '<div class="empty-state"><h3>No pending bills üéâ</h3><p>All caught up!</p></div>';
        }

        function renderSummary() {
            const filtered = getFilteredByPeriod();
            const completed = filtered.filter(t => t.status !== 'pending');
            
            const income = completed.filter(t => t.type === 'income').reduce((s, t) => s + (t.amount || 0), 0);
            const expense = completed.filter(t => t.type === 'expense').reduce((s, t) => s + (t.amount || 0), 0);
            const net = income - expense;

            // Category breakdown
            const categories = {};
            completed.filter(t => t.type === 'expense').forEach(tx => {
                categories[tx.category] = (categories[tx.category] || 0) + (tx.amount || 0);
            });
            const topCategories = Object.entries(categories)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            document.getElementById('summaryContent').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-secondary);">Net Cash Flow</span>
                        <span style="font-weight: 700; font-size: 18px; color: ${net >= 0 ? 'var(--green)' : 'var(--red)'};">${net >= 0 ? '+' : ''}${formatCurrency(net)}</span>
                    </div>
                    <div style="height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${income > 0 ? Math.min((expense / income) * 100, 100) : 0}%; background: ${net >= 0 ? 'var(--green)' : 'var(--red)'}; border-radius: 4px;"></div>
                    </div>
                </div>
                ${topCategories.length > 0 ? `
                    <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 12px;">TOP EXPENSES</div>
                    ${topCategories.map(([cat, amount]) => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span style="text-transform: capitalize;">${cat}</span>
                            <span style="font-weight: 600;">${formatCurrency(amount)}</span>
                        </div>
                    `).join('')}
                ` : '<div class="empty-state"><p>Add expenses to see breakdown</p></div>'}
            `;
        }

        function updateNavBadges() {
            const pending = transactions.filter(t => t.status === 'pending');
            const overdue = pending.filter(t => getDaysUntilDue(t.dueDate) < 0);
            
            document.getElementById('navTxCount').textContent = transactions.length;
            
            const billBadge = document.getElementById('navBillCount');
            if (overdue.length > 0) {
                billBadge.textContent = overdue.length;
                billBadge.style.display = 'inline';
                billBadge.style.background = 'var(--red)';
            } else if (pending.length > 0) {
                billBadge.textContent = pending.length;
                billBadge.style.display = 'inline';
                billBadge.style.background = 'var(--orange)';
            } else {
                billBadge.style.display = 'none';
            }
        }

        // ========== EXPORT/IMPORT ==========
        function exportData() {
            const data = { transactions, settings, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `cashflow-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('Exported!', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (data.transactions) {
                            transactions = [...data.transactions, ...transactions];
                            await saveData();
                        }
                        if (data.settings) {
                            settings = { ...settings, ...data.settings };
                            localStorage.setItem('cf_settings', JSON.stringify(settings));
                            document.getElementById('startingBalance').value = settings.startingBalance;
                            document.getElementById('businessName').value = settings.businessName;
                            document.getElementById('currency').value = settings.currency;
                        }
                        updateUI();
                        showToast('Imported!', 'success');
                    } catch (e) {
                        showToast('Import failed', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ========== TOAST ==========
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
